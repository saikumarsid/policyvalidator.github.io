<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SES Conviva Policy Validator üéà</title>
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #c2e9fb, #e2f0cb);
    margin: 0;
    padding: 20px;
    color: #333;
  }
  h1 {
    text-align: center;
    color: #004085;
    font-size: 2.4em;
    margin-bottom: 25px;
    text-shadow: 1px 1px 2px #ffffff;
  }
  .container {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 20px;
  }
  .input-box {
    flex: 1;
    min-width: 380px;
    max-width: 480px;
    background: linear-gradient(135deg, #ffffff, #f1f8ff);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
  }
  h3 {
    color: #00796b;
    text-align: center;
    margin-top: 0;
  }
  textarea {
    width: 100%;
    height: 220px;
    font-family: monospace;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    resize: none;
    font-size: 14px;
    background-color: #fafafa;
  }
  button {
    margin-top: 12px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background-color: #00bcd4;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    width: 100%;
  }
  button:hover { background-color: #0097a7; }
  .secondary-btn { width: 48%; display: inline-block; }
  table {
    border-collapse: collapse;
    width: 100%;
    background-color: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
  }
  th {
    background-color: #4a90e2;
    color: white;
  }
  tr:nth-child(even) { background-color: #f4f9ff; }
  .mismatch {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    font-weight: bold;
  }
  .compare-container {
    text-align: center;
    margin-top: 25px;
  }
  .compare-btn { background-color: #8e44ad; }
  .compare-btn:hover { background-color: #6d3393; }
  .result-box {
    max-width: 700px;
    margin: 25px auto;
    padding: 18px 20px;
    border-radius: 12px;
    text-align: left;
    font-weight: bold;
    font-size: 1em;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    line-height: 1.5em;
  }
  .success {
    background-color: #d4edda;
    color: #155724;
    border-left: 6px solid #28a745;
  }
  .error {
    background-color: #f8d7da;
    color: #721c24;
    border-left: 6px solid #dc3545;
  }
  .error ul { margin-top: 8px; padding-left: 25px; }
  .edit-btn { background-color: #ff9800; margin-top: 12px; }
  .edit-btn:hover { background-color: #f57c00; }
</style>
</head>
<body>
<h1>SES Policy Validator üéà</h1>
<div class="container">
  <div class="input-box" id="box1">
    <h3>Policy Received by Mail üì©</h3>
    <textarea id="data1" placeholder="Paste vertical data here..."></textarea>
    <button onclick="convertToTable(1)">Convert to Table</button>
  </div>
  <div class="input-box" id="box2">
    <h3>Updated Conviva Policy üì§</h3>
    <textarea id="data2" placeholder="Paste tab or space-separated data with headers (Share, Primary, Backup Resource(s))..."></textarea>
    <button onclick="convertToTable(2)">Convert to Table</button>
  </div>
</div>

<div class="compare-container">
  <button class="compare-btn" onclick="compareTables()">Compare Policies</button>
</div>

<div id="result" class="result-box" style="display:none;"></div>

<script>
let tableData1 = [];
let tableData2 = [];

// --- Policy Data 1 Parser ---
function parsePolicy1Data(text) {
  const lines = text.trim().split(/\r?\n+/).map(v => v.trim()).filter(Boolean);
  const rows = [["Share", "Primary Resource", "Backup Resource(s)"]];
  let i = 0;
  while (i < lines.length) {
    const share = lines[i];
    if (!/^\d+(\.\d+)?%?$/.test(share)) { i++; continue; }
    const shareWithPercent = share.endsWith('%') ? share : share + '%';
    const resources = [];
    i++;
    while (i < lines.length && !/^\d+(\.\d+)?%?$/.test(lines[i])) {
      resources.push(lines[i]);
      i++;
    }
    const primary = resources[0] || "";
    const backups = resources.slice(1).join(", ");
    rows.push([shareWithPercent, primary, backups]);
  }
  return rows;
}

// --- Policy Data 2 Parser (with comma-separated backup resources) ---
function parsePolicy2Data(text) {
  const lines = text.trim().split(/\r?\n+/).map(v => v.trim()).filter(Boolean);
  if (lines.length === 0) return [];
  const headers = ["Share", "Primary Resource", "Backup Resource(s)"];
  const rows = [headers];
  let startIndex = 0;
  if (/share|primary|backup/i.test(lines[0])) startIndex = 1;

  for (let i = startIndex; i < lines.length; i++) {
    const parts = lines[i].split(/\t| +/).filter(Boolean);
    if (parts.length < 3) continue;

    let share = parts[0];
    if (/^\d+(\.\d+)?$/.test(share) && !share.endsWith('%')) share += '%';

    const primary = parts[1];

    // --- Split backup resources by pattern and join with comma+space ---
    const backupStr = parts.slice(2).join(" ");
    const resources = backupStr.match(/[A-Z]{2,4}-[A-Z]-Live(?:-[A-Z]{2})?/g) || [];
    const backups = resources.join(", ");

    rows.push([share, primary, backups]);
  }
  return rows;
}

// --- Convert to Table ---
function convertToTable(num) {
  const textarea = document.getElementById(`data${num}`);
  const data = textarea.value.trim();
  if (!data) return alert("Please paste policy data first.");
  const rows = num === 1 ? parsePolicy1Data(data) : parsePolicy2Data(data);

  const table = document.createElement("table");
  table.id = `table${num}`;
  const header = document.createElement("tr");
  rows[0].forEach(col => {
    const th = document.createElement("th");
    th.textContent = col;
    header.appendChild(th);
  });
  table.appendChild(header);

  for (let i = 1; i < rows.length; i++) {
    const tr = document.createElement("tr");
    rows[i].forEach(col => {
      const td = document.createElement("td");
      td.textContent = col;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  }

  const box = document.getElementById(`box${num}`);
  textarea.style.display = "none";
  box.querySelector("button").style.display = "none";
  box.appendChild(table);

  const controls = document.createElement("div");
  controls.style.textAlign = "center";
  controls.style.marginTop = "10px";

  const editBtn = document.createElement("button");
  editBtn.textContent = "üîÅ Edit Data";
  editBtn.className = "edit-btn secondary-btn";
  editBtn.onclick = () => {
    table.remove();
    controls.remove();
    textarea.style.display = "block";
    box.querySelector("button").style.display = "block";
  };

  const clearBtn = document.createElement("button");
  clearBtn.textContent = "üßπ Clear Data";
  clearBtn.className = "secondary-btn";
  clearBtn.style.backgroundColor = "#dc3545";
  clearBtn.onclick = () => {
    textarea.value = "";
    table.remove();
    controls.remove();
    textarea.style.display = "block";
    box.querySelector("button").style.display = "block";
  };

  const copyBtn = document.createElement("button");
  copyBtn.textContent = "üìã Copy Data";
  copyBtn.className = "secondary-btn";
  copyBtn.style.backgroundColor = "#28a745";
  copyBtn.onclick = () => {
    const textToCopy = rows.map(r => r.join("\t")).join("\n");
    navigator.clipboard.writeText(textToCopy);
    alert("‚úÖ Table data copied to clipboard!");
  };

  controls.appendChild(editBtn);
  controls.appendChild(clearBtn);
  controls.appendChild(copyBtn);
  box.appendChild(controls);

  if (num === 1) tableData1 = rows;
  else tableData2 = rows;
}

// --- Normalization Helper ---
function normalize(value) {
  return (value || "")
    .toString()
    .trim()
    .replace(/\s*,\s*/g, ",")
    .replace(/\s+/g, " ")
    .replace(/%$/, "")
    .toLowerCase();
}

// --- Compare Tables ---
function compareTables() {
  const result = document.getElementById("result");
  result.style.display = "block";
  result.innerHTML = "";
  result.className = "result-box";
  if (!tableData1.length || !tableData2.length) {
    result.textContent = "‚ö†Ô∏è Please convert both policy data sets first.";
    result.classList.add("error");
    return;
  }

  document.querySelectorAll(".mismatch").forEach(el => el.classList.remove("mismatch"));
  const table1 = document.getElementById("table1");
  const table2 = document.getElementById("table2");
  const maxRows = Math.max(tableData1.length, tableData2.length);
  let mismatch = false;
  let mismatches = [];

  for (let i = 1; i < maxRows; i++) {
    const row1 = tableData1[i] || [];
    const row2 = tableData2[i] || [];
    const maxCols = Math.max(row1.length, row2.length);
    for (let j = 0; j < maxCols; j++) {
      const val1 = normalize(row1[j]);
      const val2 = normalize(row2[j]);
      if (val1 !== val2) {
        mismatch = true;
        mismatches.push(`Row ${i}, Column ${j + 1}`);
        if (table1 && table1.rows[i] && table1.rows[i].cells[j])
          table1.rows[i].cells[j].classList.add("mismatch");
        if (table2 && table2.rows[i] && table2.rows[i].cells[j])
          table2.rows[i].cells[j].classList.add("mismatch");
      }
    }
  }

  if (!mismatch) {
    alert("‚úÖ Policies are matched ‚Äî good to go!");
    result.textContent = "‚úÖ Policies are matched ‚Äî good to go!";
    result.classList.add("success");
  } else {
    result.classList.add("error");
    result.innerHTML =
      "<strong>‚ùå Mismatch found!</strong><br><ul>" +
      mismatches.map(m => `<li>${m}</li>`).join("") +
      "</ul>";
  }
}
</script>

</body>
</html>
